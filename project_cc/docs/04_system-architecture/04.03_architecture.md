# 04.03 Architecture  
**The Content Creator (CC / ACC)**  
Single-Spine Automated Content Delivery System

---

## Purpose

This document translates the CC / ACC system into an implementable architecture that:
- Preserves the product promise: **continuity without user effort**
- Prevents vendor/tool lock-in
- Survives user inactivity and staff turnover
- Scales from hundreds to thousands without per-user workflows

**Success metric:** “I disappeared… and this didn’t.”

---

## Non-Negotiable Product Contract

What the system must deliver (hard contract):
- **Asset:** One 30-second vertical short
- **Format:** 9:16 (platform-ready)
- **Cadence:** Every other day
- **Delivery channel:** Email (canonical surface)
- **Start condition:** Prompt profile completion
- **User requirements after onboarding:** None

Everything else is implementation detail.

---

## System Spine (Mental Model)

A single, replaceable spine:

HubSpot (Memory / Ledger)
↓
n8n (Operator / Orchestrator)
↓
Generators (Stateless Vendors)
↓
Email (The Product)


### Role definitions
- **HubSpot:** canonical state store, audit trail, human-safe overrides  
  ❌ Not a scheduler, not a workflow engine, not a logic layer
- **n8n:** owns orchestration, idempotency, retries, failure classification, cadence enforcement  
  ✅ The brain
- **Generators (OpenAI, media vendors):** stateless output modules  
  ✅ Consume structured snapshots, never hold memory
- **Email (Postmark):** the only surface Sarah experiences  
  ✅ Delivery confirmation is the write gate

---

## Key Architectural Principles

1. **State is owned by n8n**  
   n8n controls retries, idempotency, and commit rules. HubSpot stores state, but does not drive logic.

2. **Point-in-time snapshots only**  
   Each delivery cycle uses a single read snapshot of user variables. No mid-flow “live” CRM reads.

3. **Commit-only writes**  
   HubSpot writes occur only after:
   - successful generation/render
   - successful email send
   - delivery confirmation (when available)

4. **Silence is a valid user state**  
   No workflow may require user action to restore delivery.

5. **No per-user workflows**  
   One shared parameterized spine. If a change implies cloning flows, it is rejected.

---

## Core Components

### Intake (Lead Capture)
- Source: WIX landing page form
- Operator: n8n webhook intake
- Output: normalized payload → HubSpot upsert → lifecycle initialization

### Profile (Prompt Variables)
- Stored as atomic HubSpot properties (append-safe, schema-versioned)
- Partial completion is valid; critical missing fields can pause delivery silently

### Delivery Spine (Recurring)
- Trigger: schedule (cron) + eligibility checks (next eligible send)
- Reads: HubSpot contact snapshot
- Generates: script + assets via vendors
- Sends: Postmark email
- Commits: HubSpot timestamps and delivery metadata

### Overrides (Human Safe)
- Support can pause/suppress
- Engineering can re-run with idempotency keys and bounded replay
- Users do not interact with system state

---

## Data Flow

### Read Path (Every Delivery Cycle)
1. Scheduler fires in n8n
2. n8n queries HubSpot for eligible contacts (delivery_status + next_eligible_send_at)
3. n8n fetches full contact snapshot
4. n8n builds a structured prompt payload
5. Payload is sent to generators (stateless)
6. Generated output is validated (guardrails)

### Write Path (Commit Only)
7. Media render completes
8. Email send completes
9. Delivery confirmation received (or best-available send success)
10. n8n commits to HubSpot:
   - `cc_last_delivery_at`
   - `cc_next_eligible_send_at`
   - `cc_delivery_count`
   - `cc_last_asset_id`
   - error flags (only if applicable)

**Rule:** No optimistic writes.

---

## State Model

### Delivery Status (operational)
Typical states:
- `active` — normal delivery
- `onboarding` — setup in progress
- `paused` — manual/safety pause
- `error` — repeated failure requires recovery
- `suppressed` — explicit stop; never auto-resume

### Eligibility Gates
A contact is eligible when:
- delivery_status == `active`
- prompt profile meets minimum critical completeness
- now ≥ `cc_next_eligible_send_at`
- not suppressed by compliance/bounce rules

---

## Idempotency & Replay Safety

### Idempotency goals
- Prevent duplicate deliveries
- Allow safe retries after partial failure
- Enable bounded replays for recovery

### Recommended keys
- **Delivery cycle key:** `contact_id + scheduled_window + cadence_index`
- **Vendor job key:** `delivery_cycle_key + vendor_name + job_type`
- **Email key:** `delivery_cycle_key + message_template_version`

### Replay rules
- Safe to replay generation if email not sent
- Safe to replay send if vendor assets are immutable and message idempotency is enforced
- Never replay a cycle that already committed `cc_last_delivery_at` for that window unless in explicit recovery mode

---

## Failure Handling Strategy

### Failure classes (examples)
- HubSpot timeouts / rate limits
- Schema mismatch / missing property
- Partial variable availability
- Vendor generation failure
- Vendor render failure
- Email send failure / bounce spike

### Recovery behaviors (silent by default)
- Exponential backoff retries for transient failures
- Cached snapshot usage when safe (bounded TTL)
- Default fallbacks for non-critical variables
- Critical missing variables → silent pause (internal alert only)
- Vendor outage → hold and retry on next cycle without user involvement

**Rule:** Sarah is never asked to “fix her profile.”

---

## Observability & Auditability

### Required internal signals
- Delivery success rate (rolling window)
- Time-to-delivery from eligibility to send
- Error rate by failure class
- Vendor latency and failure distribution
- Bounce rate and suppression counts

### Audit trail (HubSpot)
- last delivery timestamps
- delivery counts
- last asset identifiers
- error flags and last error class

**Rule:** Operational health is internal. Do not surface “system status” to the user.

---

## Security & Governance

### Access control
- n8n: scoped read/write only to CC properties
- Support: read + pause/suppress only
- Sales: lifecycle fields only
- Marketing: no access to delivery properties
- User: no access

### Vendor abstraction
All vendors are replaceable modules. No vendor holds system state.
If a vendor changes or fails, n8n and HubSpot still define continuity.

---

## Scaling Rules (Non-Optional)

To scale beyond 1,000 users:
- One contact = one delivery stream
- One shared delivery spine
- No per-user workflow clones
- No per-user branching logic that grows unbounded
- Batch reads where possible; single writes only on commit

If a proposal requires:
- manual reconciliation
- CRM cleanup
- human intervention to restore delivery  
…it will fail at scale and must be rejected.

---

## Change Management

Before shipping changes that affect:
- HubSpot properties
- Prompt payload schema
- Delivery cadence rules
- Email templates

Required artifacts:
- CRM schema reference updated
- Prompt schema version log updated
- n8n ↔ HubSpot contract updated
- Backward compatibility notes documented

If documentation does not exist, the change does not ship.

---

## Architectural North Star

You are not building features.

You are maintaining an inevitable engine where:
- Sarah can disappear
- Engineers can sleep
- Leadership can trust continuity
- Content keeps shipping
